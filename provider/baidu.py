from math import *

from vendor import coord
from vendor.combine import Combine
from vendor.pool import Pool


R = 6378800
BASEURL = 'http://online{}.map.bdimg.com/onlinelabel/?qt=tile&x={}&y={}&z={}&styles=pl'
p = Pool(4)
Tp = [
    [-0.0015702102444, 111320.7020616939, 1704480524535203, -10338987376042340, 26112667856603880, -35149669176653700, 26595700718403920, -10725012454188240, 1800819912950474, 82.5],
    [8.277824516172526E-4, 111320.7020463578, 6.477955746671607E8, -4.082003173641316E9, 1.077490566351142E10, -1.517187553151559E10, 1.205306533862167E10, -5.124939663577472E9, 9.133119359512032E8, 67.5],
    [0.00337398766765, 111320.7020202162, 4481351.045890365, -2.339375119931662E7, 7.968221547186455E7, -1.159649932797253E8, 9.723671115602145E7, -4.366194633752821E7, 8477230.501135234, 52.5],
    [0.00220636496208, 111320.7020209128, 51751.86112841131, 3796837.749470245, 992013.7397791013, -1221952.21711287, 1340652.697009075, -620943.6990984312, 144416.9293806241, 37.5],
    [-3.441963504368392E-4, 111320.7020576856, 278.2353980772752, 2485758.690035394, 6070.750963243378, 54821.18345352118, 9540.606633304236, -2710.55326746645, 1405.483844121726, 22.5],
    [-3.218135878613132E-4, 111320.7020701615, 0.00369383431289, 823725.6402795718, 0.46104986909093, 2351.343141331292, 1.58060784298199, 8.77738589078284, 0.37238884252424, 7.45]]


def sgn(x):
    if x < 0:
        return -1
    return 1


def tms2bd(x, y, z):
    lat, lon = coord.wgs2bd(*coord.tms2wgs(x, y, z))
    z += 1
    for d, Kj_d in enumerate(range(75, -15, -15)):
        if (abs(lat) >= Kj_d):
            c = Tp[d]
            y = abs(lat) / c[9]
            y = (c[2] + c[3] * y + c[4] * y ** 2 + c[5] * y ** 3 +
                 c[6] * y ** 4 + c[7] * y ** 5 + c[8] * y ** 6) * sgn(lat)
            x = (c[0] + c[1] * abs(lon)) * sgn(lon)
            x, m = divmod(floor(x * 2 ** (z - 18)), 256)
            y, n = divmod(floor(y * 2 ** (z - 18)), 256)
            n = 255 - n
            return x, y, z, m, n


def bd_url_formatter(url):
    return lambda x, y, z: url.format(p.get((x, y, z)), *map(
        lambda x: 'M' + str(-x) if x < 0 else str(x), (x, y, z)))


bd_combiner = Combine(bd_url_formatter(BASEURL), tms2bd)


def fetch(x, y, z):
    if not 2 <= z <= 18:
        raise ValueError
    return bd_combiner.get(x, y, z)
